#!/bin/bash
# Hannu Vuolasaho 2012 vuokkosetae@gmail.com
#
# This script generates QR knitting grid from input text
# This requires libpng, netbmtools and qrencode
# Example ./generate "Text shirt sucks"

# Non ASCII character's propably don't work. Output tested only with zbarimg

# Ver 1.0
# LISENCE
# GPL V2 or later.
# TODO
# Write the 100x100 grid more elegantly.
# Clean up input.
# Make directory and move images there.

# Generate png images from lowest error correction to highest.
qrencode -s 10 -l L -o low.png "$@"
qrencode -s 10 -l M -o med.png "$@"
qrencode -s 10 -l Q -o q.png "$@"
qrencode -s 10 -l H -o hi.png "$@"


# Transcode to pnm
png2pnm low.png >low.pnm
png2pnm med.png >med.pnm
png2pnm q.png >q.pnm
png2pnm hi.png >hi.pnm

# Generate the grid.
echo "P1">grid100.pbm
echo "100 100">>grid100.pbm
echo "0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000">>grid100.pbm
echo "0111111111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0111001111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0110000111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0110110111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0110110111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0110110111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0110010111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0111001111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0111111111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000">>grid100.pbm
echo "0111111111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0111001111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0110110111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0110110111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0111000111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0111110111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0111100111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0110001111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0111111111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000">>grid100.pbm
echo "0111111111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0110001111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0110110111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0110110111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0111001111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0110110111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0110110111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0110000111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0111111111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000">>grid100.pbm
echo "0111111111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0110000111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0111100111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0111101111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0111101111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0111101111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0111011111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0111011111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0111111111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000">>grid100.pbm
echo "0111111111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0111000111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0110011111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0110111111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0110000111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0110110111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0110110111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0110000111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0111111111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000">>grid100.pbm
echo "0111111111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0110000111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0110111111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0110111111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0110001111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0111110111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0111100111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0110001111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0111111111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000">>grid100.pbm
echo "0111111111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0111100111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0111100111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0111010111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0111010111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0110010111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0110000011011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0111110111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0111111111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000">>grid100.pbm
echo "0111111111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0110001111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0110110111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0111110111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0111001111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0111100111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0110110111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0110001111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0111111111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000">>grid100.pbm
echo "0111111111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0111001111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0110110111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0111110111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0111101111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0111011111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0110111111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0110000111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0111111111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000">>grid100.pbm
echo "0111111111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm
echo "0111001111011100111101100011110111100111011000011101110001110110000111011000111101110011110111001111">>grid100.pbm
echo "0111101111011011011101101101110111100111011011111101100111110111100111011011011101101101110110000111">>grid100.pbm
echo "0111101111011111011101111101110111010111011011111101101111110111101111011011011101101101110110110111">>grid100.pbm
echo "0111101111011110111101110011110111010111011000111101100001110111101111011100111101110001110110110111">>grid100.pbm
echo "0111101111011101111101111001110110010111011111011101101101110111101111011011011101111101110110110111">>grid100.pbm
echo "0111101111011011111101101101110110000011011110011101101101110111011111011011011101111001110110010111">>grid100.pbm
echo "0111000111011000011101100011110111110111011000111101100001110111011111011000011101100011110111001111">>grid100.pbm
echo "0111111111011111111101111111110111111111011111111101111111110111111111011111111101111111110111111111">>grid100.pbm

# Generate red pixel
echo -e "P3\n1 1 255\n255 0 0\n">>red_pixel.ppm

pnmscale 450 red_pixel.ppm >red_block.ppm
for result in "low" "med" "q" "hi"
do
    # Count the size of the grid
    picture_size=`head -n 2 $result.pnm|tail -n 1|awk '{print $1}'`
    grid_size=`expr $picture_size \/ 100`
    grid_size=`expr $grid_size + 1`
    grid_size=`expr $grid_size \* 100`
    # Copy the grid in full blocks bigger than the picture
    pnmtile $grid_size $grid_size grid100.pbm > grid.pbm
    # Cut excess grid off from top and right
    pnmcut -top=`expr $picture_size \* -1` \
	-right=`expr $picture_size - 1` grid.pbm >tmp.pbm
    mv tmp.pbm grid.pbm
    pnmscale $picture_size red_pixel.ppm >red_block.ppm
    pnmcomp -alpha=grid.pbm red_block.ppm $result.pnm|pnm2png \
	> pattern-error-correction-$result.png
    rm -f $result.pnm
done
rm -f hi.pnm lo.pnm med.pnm q.pnm grid100.pbm grid.pbm 
rm -f red_pixel.ppm red_block.ppm
exit 0

